import{a as A,u as T,r as i,l as W,c as p,o as B,b as U,M as j,D as z,e as L,f as Y,h as C,v as N,E as S,q as G}from"./index-10307767.js";/* empty css                                                     */const Q={__name:"CameraModule",setup(H){const M=A(),c=T(),s=i(null),u=i(null),d=i(null),y=i(!1),R=i(null),w=i(""),g=i(!1);let O=960,D=640,o,n,f=!0;W("$bus").on("toggleMode",b);const x=p(()=>c.getters.currentOption),E=p(()=>y.value?"user":"environment"),_=p(()=>c.getters.worker),v=p(()=>c.getters.processConfigs),I=p(()=>v.value.map((e,r)=>({title:e.title,index:e.index,selected:e.selected,videoAvailable:e.videoAvailable,params:e.params.map($=>$.paramValue)})));let a,t,l;function b(){R.value.animate([{transform:"rotateY(0)"},{transform:"rotateY(360deg)"}],1200),y.value=!y.value,h()}async function h(){g.value=!0,console.log("cameraInit");try{if(l&&m(),l=await navigator.mediaDevices.getUserMedia({video:{facingMode:E.value,width:O,height:D},audio:!1}),l){let e=l.getVideoTracks()[0].getSettings();console.log("mediaStream",l);let r=screen.orientation.type;r=="landscape-primary"||r=="landscape-secondary"?(a=Math.max(e.width,e.height),t=Math.min(e.width,e.height)):(a=Math.min(e.width,e.height),t=Math.max(e.width,e.height)),s.value.srcObject=l,s.value.play(),F()}else return g.value=!1,f&&M.push({path:"/noCamera/CameraError",replace:!0}),!1}catch{return g.value=!1,m(),f&&M.push({path:"/noCamera/CameraError",replace:!0}),!1}}async function q(){await G(),_.value.onmessage=function(e){k(),e.data.msg=="error"&&(e.data.indexs.map(r=>{v.value[r].selected=!1}),console.log(error),w.value=error.toString()),(!n||!o)&&(n=d.value.getContext("2d",{willReadFrequently:!0}),o=u.value.getContext("2d",{willReadFrequently:!0})),n.clearRect(0,0,a,t),n.putImageData(e.data.image,0,0),e.data.type=="processError"&&e.data.indexs.map(r=>{v.value[r].selected=!1,S({message:`${v.value[r].title} 发生错误。${e.data.msg}.`,grouping:!0,type:"error"})})}}function F(){s.value.width=a,s.value.height=t,u.value.width=a,u.value.height=t,d.value.width=a,d.value.height=t,o=u.value.getContext("2d",{willReadFrequently:!0}),n=d.value.getContext("2d",{willReadFrequently:!0}),o.clearRect(0,0,a,t),n.clearRect(0,0,a,t),setTimeout(()=>{g.value=!1},1e3)}function k(){if(x.value!="camera"||!s.value)return!1;try{(!o||!n)&&(o=u.value.getContext("2d",{willReadFrequently:!0}),n=d.value.getContext("2d",{willReadFrequently:!0})),n.clearRect(0,0,a,t),o.clearRect(0,0,a,t),o.drawImage(s.value,0,0);let e=o.getImageData(0,0,a,t);_.value.postMessage({image:e,paramsList:I.value,type:"video"})}catch(e){return console.log(e),w.value=e.toString(),h(),!1}}function m(){l&&(l.getTracks().forEach(r=>r.stop()),l=null)}async function V(){x.value||c.dispatch("set_currentOption","camera"),S({message:"Module is loading.",duration:1e3}),console.log("orientation:",screen.orientation.type),screen.orientation.addEventListener("change",async function(){console.log("orientation:",screen.orientation.type),x.value=="camera"&&await h()}),q(),await h();try{k()}catch(e){m(),console.log(e),w.value=e.toString()}}return B(()=>{console.log("camera onMounted"),c.dispatch("set_currentOption","camera"),V()}),U(()=>{console.log("camera onActivated")}),j(()=>{f=!1,console.log("camvea onDeactivated"),m()}),z(()=>{f=!1,console.log("camera onUnmounted"),c.dispatch("set_currentOption",""),m()}),(e,r)=>(L(),Y("div",{ref_key:"cameraWrapper",ref:R,class:"cameraWrapper"},[C("video",{ref_key:"cameraInput",ref:s,id:"cameraInput"},null,512),C("canvas",{ref_key:"cameraOutput",ref:d,id:"cameraOutput",style:N({opacity:g.value?"0":"1"})},null,4),C("canvas",{id:"canvasRead",ref_key:"canvasRead",ref:u,style:{display:"none"}},null,512)],512))}};export{Q as default};
