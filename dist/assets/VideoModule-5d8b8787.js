import{u as X,r as s,c as O,o as Y,q as U,b as ee,M as ae,D as te,d as w,e as f,f as x,h as l,I as E,g as n,w as _,H as T,E as L,F as le,x as oe,i as z,O as se,P as ne,Q as ie,R as ue}from"./index-10307767.js";/* empty css                                                    */const de={class:"videoArea"},re={class:"playerWrapper"},ce={key:0,class:"videoCanvasWrapper"},ve=["src"],pe={class:"videoController"},fe={class:"videoInputSource"},ge=l("text",null,"Input Source",-1),me=l("span",{style:{"margin-left":"5px"}},"上传视频",-1),_e={class:"controllerCenter"},ye={class:"mask"},he=l("text",null,"Mask",-1),Ce={__name:"VideoModule",setup(we){const g=X(),W=["mp4","m4s","avi"],b=s([{label:"test",value:"/videos/sintel.mp4"}]),k=s("/videos/sintel.mp4"),C=s(null),R=s("40px"),c=s(!1),t=s(null);s(Object);const v=s(null),y=s(null),$=s(null),M=s(50);let m,o;const F=O(()=>g.getters.currentOption),q=O(()=>g.getters.worker),V=O(()=>g.getters.processConfigs),A=O(()=>V.value.map((e,a)=>({title:e.title,index:e.index,selected:e.selected,videoAvailable:e.videoAvailable,params:e.params.map(h=>h.paramValue)})));let u,d,I;async function p(e){if(F.value!="video"||!t.value)return!1;try{t.value.src!=""&&(e?(await t.value.play(),c.value=!0,D()):(await t.value.pause(),c.value=!1))}catch(a){console.log(a)}}function D(){if(c.value){console.log("processing Video"),(!m||!o)&&(m=y.value.getContext("2d",{willReadFrequently:!0}),o=v.value.getContext("2d",{willReadFrequently:!0})),m.clearRect(0,0,u,d),m.drawImage(t.value,0,0);let e=m.getImageData(0,0,u,d);q.value.postMessage({module:"video",image:e,paramsList:A.value,module:"video"})}}function B(){console.log("zoom",I),t.value.currentTime+10<I?t.value.currentTime+=10:t.value.currentTime=I}function N(){t.value.currentTime-10>0?t.value.currentTime-=10:t.value.currentTime=0}function S(){C.value.click()}async function H(){console.log("fileChange");const e=C.value.files[0];if(e){const a=e.name,h=a.split(".").pop();if(W.indexOf(h)!=-1){const r=URL.createObjectURL(e);t.value.src=r,b.value.push({label:a,value:r}),k.value=r,t.value.load()}else L({type:"error",message:"输入格式不支持"})}}function j(){console.log("video Init"),g.dispatch("set_currentOption","video")}async function P(){await U(),q.value.onmessage=function(e){e.data.module=="video"&&(e.data.type=="processError"?e.data.indexs.map(a=>{V.value[a].selected=!1,L({message:`${V.value[a].title} 发生错误。${e.data.msg}`,grouping:!0,type:"error"})}):e.data.type=="error"&&(console.log("error",e.data.indexs),L({message:"something went wrong",grouping:!0,type:"error",duration:1e3}),e.data.indexs.map(a=>{V.value[a].selected=!1})),o||(o=v.value.getContext("2d",{willReadFrequently:!0})),o.clearRect(0,0,u,d),o.putImageData(e.data.image,0,0),D())}}async function Q(){await U(),I=t.value.duration,u=t.value.videoWidth,d=t.value.videoHeight,v.value.width=u,v.value.height=d,y.value.width=u,y.value.height=d,m=y.value.getContext("2d",{willReadFrequently:!0}),o=v.value.getContext("2d",{willReadFrequently:!0}),o.clearRect(0,0,u,d)}return Y(async()=>{console.log("video onMounted"),g.dispatch("set_currentOption","video"),await U(),P(),j(),t.value.addEventListener("loadedmetadata",async()=>{console.log("metaData Loaded"),Q(),p(!1)}),t.value.addEventListener("play",function(){console.log("视频开始播放"),p(!0)}),t.value.addEventListener("pause",function(){console.log("视频已暂停"),p(!1)}),C.value.addEventListener("change",H)}),ee(async()=>{console.log("video Activated")}),ae(()=>{console.log("video onDeactivated"),c.value=!1;try{o||(o=v.value.getContext("2d",{willReadFrequently:!0})),o.clearRect(0,0,u,d)}catch{}}),te(async()=>{console.log("video onUnmounted"),g.dispatch("set_currentOption","none"),await U(),console.log(F.value),c.value=!1;try{o||(o=v.value.getContext("2d",{willReadFrequently:!0})),o.clearRect(0,0,u,d)}catch{}}),(e,a)=>{const h=w("UploadFilled"),r=w("el-icon"),Z=w("el-option"),G=w("el-select"),J=w("el-slider");return f(),x("div",{ref_key:"videoModuleWrapper",ref:$,class:"videoModuleWrapper"},[l("div",de,[l("div",{class:"tvHead",onClick:a[5]||(a[5]=i=>p(!c.value))},[l("div",re,[F.value=="video"?(f(),x("div",ce,[l("video",{ref_key:"videoInput",ref:t,src:k.value,id:"videoInput",poster:"",loop:"",crossorigin:"true"},null,8,ve),l("canvas",{id:"canvasOutput",ref_key:"canvasOutput",ref:v},null,512),l("canvas",{id:"canvasRead",ref_key:"canvasRead",ref:y,style:{display:"none"}},null,512)])):E("",!0)]),l("div",pe,[l("div",fe,[ge,n(G,{modelValue:k.value,"onUpdate:modelValue":a[0]||(a[0]=i=>k.value=i),placeholder:"请选择输入源",onChange:a[1]||(a[1]=i=>p(!1))},{default:_(()=>[l("div",{class:"el-select-dropdown__item",onClick:S},[n(r,null,{default:_(()=>[n(h)]),_:1}),me]),(f(!0),x(le,null,oe(b.value,(i,K)=>(f(),T(Z,{label:i.label,value:i.value,key:K},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),l("div",_e,[l("div",{class:"leftright",onClick:N},[n(r,{size:R.value},{default:_(()=>[n(z(se))]),_:1},8,["size"])]),c.value?(f(),x("div",{key:1,class:"centerIcon",onClick:a[3]||(a[3]=i=>p(!1))},[n(r,{size:R.value},{default:_(()=>[n(z(ie))]),_:1},8,["size"])])):(f(),x("div",{key:0,class:"centerIcon",onClick:a[2]||(a[2]=i=>p(!0))},[c.value?E("",!0):(f(),T(r,{key:0,size:R.value},{default:_(()=>[n(z(ne))]),_:1},8,["size"]))])),l("div",{class:"leftright",onClick:B},[n(r,{size:R.value},{default:_(()=>[n(z(ue))]),_:1},8,["size"])])]),l("div",ye,[he,n(J,{modelValue:M.value,"onUpdate:modelValue":a[4]||(a[4]=i=>M.value=i),step:.1},null,8,["modelValue"])])])]),l("input",{type:"file",style:{display:"none"},id:"videoUpload",ref_key:"videoUpload",ref:C},null,512)])],512)}}};export{Ce as default};
